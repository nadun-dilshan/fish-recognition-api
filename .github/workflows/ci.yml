name: Fish API CI Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "&&"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3️⃣ Install system dependencies (for OpenCV)
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1 libglib2.0-0

      # 4️⃣ Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5️⃣ Environment variables (CI-safe)
      - name: Set environment variables
        run: |
          echo "MODEL_PATH=models/fish_model.keras" >> $GITHUB_ENV
          echo "PORT=5002" >> $GITHUB_ENV
          echo "THRESHOLD=0.75" >> $GITHUB_ENV
          echo "MIN_GAP=0.20" >> $GITHUB_ENV

      # 6️⃣ Lint check (basic)
      - name: Python syntax check
        run: |
          python -m py_compile app.py

      # 7️⃣ Health check (start & test)
      - name: Run Flask app (health check)
        run: |
          python app.py &
          sleep 10
          curl http://127.0.0.1:5002/health
